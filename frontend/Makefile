.PHONY: help prod dev restart stop logs status cleanup build test deploy

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¢œè‰²å®šä¹‰
GREEN  := \033[0;32m
YELLOW := \033[0;33m
BLUE   := \033[0;34m
NC     := \033[0m # No Color

##@ å¸¸ç”¨å‘½ä»¤

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(BLUE)ç®—åŠ›è¶…å¸‚å‰ç«¯ - Docker éƒ¨ç½²$(NC)"
	@echo ""
	@sed -n 's/^##//p' ${MAKEFILE_LIST} | column -t -s ':' | sed -e 's/^/ /'
	@echo ""

prod: ## å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
	@echo "$(GREEN)ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	@./start-prod.sh

dev: ## å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
	@echo "$(GREEN)ğŸ”§ å¯åŠ¨å¼€å‘ç¯å¢ƒ...$(NC)"
	@./start-dev.sh

restart: ## é‡å¯ç”Ÿäº§ç¯å¢ƒ
	@echo "$(YELLOW)ğŸ”„ é‡å¯ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	@./restart-prod.sh

stop: ## åœæ­¢ç”Ÿäº§ç¯å¢ƒ
	@echo "$(YELLOW)ğŸ›‘ åœæ­¢ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	@./stop-prod.sh

stop-dev: ## åœæ­¢å¼€å‘ç¯å¢ƒ
	@echo "$(YELLOW)ğŸ›‘ åœæ­¢å¼€å‘ç¯å¢ƒ...$(NC)"
	@./stop-dev.sh

##@ ç›‘æ§å‘½ä»¤

logs: ## æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
	@echo "$(BLUE)ğŸ“‹ ç”Ÿäº§ç¯å¢ƒæ—¥å¿— (Ctrl+C é€€å‡º)$(NC)"
	@docker-compose logs -f

logs-dev: ## æŸ¥çœ‹å¼€å‘ç¯å¢ƒæ—¥å¿—
	@echo "$(BLUE)ğŸ“‹ å¼€å‘ç¯å¢ƒæ—¥å¿— (Ctrl+C é€€å‡º)$(NC)"
	@docker-compose -f docker-compose.dev.yml logs -f

status: ## æŸ¥çœ‹å®¹å™¨çŠ¶æ€
	@./status.sh

ps: ## å¿«é€ŸæŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
	@docker-compose ps

##@ æ„å»ºå‘½ä»¤

build: ## æ„å»ºç”Ÿäº§é•œåƒ
	@echo "$(GREEN)ğŸ”¨ æ„å»ºç”Ÿäº§é•œåƒ...$(NC)"
	@docker-compose build

build-dev: ## æ„å»ºå¼€å‘é•œåƒ
	@echo "$(GREEN)ğŸ”¨ æ„å»ºå¼€å‘é•œåƒ...$(NC)"
	@docker-compose -f docker-compose.dev.yml build

rebuild: ## é‡æ–°æ„å»ºï¼ˆæ— ç¼“å­˜ï¼‰
	@echo "$(GREEN)ğŸ”¨ é‡æ–°æ„å»ºï¼ˆæ— ç¼“å­˜ï¼‰...$(NC)"
	@docker-compose build --no-cache

##@ éƒ¨ç½²å‘½ä»¤

deploy: ## å®Œæ•´éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
	@echo "$(GREEN)ğŸš€ éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ...$(NC)"
	@./deploy.sh prod

deploy-dev: ## å®Œæ•´éƒ¨ç½²å¼€å‘ç¯å¢ƒ
	@echo "$(GREEN)ğŸš€ éƒ¨ç½²å¼€å‘ç¯å¢ƒ...$(NC)"
	@./deploy.sh dev

##@ ç»´æŠ¤å‘½ä»¤

cleanup: ## æ¸…ç†Dockerèµ„æºï¼ˆäº¤äº’å¼ï¼‰
	@./cleanup.sh

prune: ## æ¸…ç†æœªä½¿ç”¨çš„Dockerèµ„æºï¼ˆè‡ªåŠ¨ï¼‰
	@echo "$(YELLOW)ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„èµ„æº...$(NC)"
	@docker system prune -f

clean: clean-img clean-cont ## æ¸…ç†é•œåƒå’Œå®¹å™¨

clean-cont: ## åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨
	@echo "$(YELLOW)ğŸ—‘ï¸  æ¸…ç†å®¹å™¨...$(NC)"
	@docker-compose down --remove-orphans 2>/dev/null || true
	@docker-compose -f docker-compose.dev.yml down --remove-orphans 2>/dev/null || true

clean-img: ## åˆ é™¤é¡¹ç›®é•œåƒ
	@echo "$(YELLOW)ğŸ—‘ï¸  æ¸…ç†é•œåƒ...$(NC)"
	@docker rmi computing-marketplace:test 2>/dev/null || echo "  æœªæ‰¾åˆ°é•œåƒ"

##@ æµ‹è¯•å‘½ä»¤

test: ## å¥åº·æ£€æŸ¥
	@echo "$(BLUE)ğŸ” å¥åº·æ£€æŸ¥...$(NC)"
	@curl -f http://localhost:3000/health && echo "$(GREEN)âœ… å¥åº·$(NC)" || echo "$(YELLOW)âš ï¸  ä¸å¥åº·$(NC)"

test-dev: ## å¼€å‘ç¯å¢ƒå¥åº·æ£€æŸ¥
	@echo "$(BLUE)ğŸ” å¥åº·æ£€æŸ¥...$(NC)"
	@curl -f http://localhost:5173 && echo "$(GREEN)âœ… æœåŠ¡æ­£å¸¸$(NC)" || echo "$(YELLOW)âš ï¸  æœåŠ¡å¼‚å¸¸$(NC)"

shell: ## è¿›å…¥å®¹å™¨shell
	@docker exec -it computing-marketplace-frontend sh

shell-dev: ## è¿›å…¥å¼€å‘å®¹å™¨shell
	@docker exec -it computing-marketplace-frontend-dev sh

##@ å¼€å‘å‘½ä»¤

dev-local: ## æœ¬åœ°å¼€å‘ï¼ˆä¸ä½¿ç”¨Dockerï¼‰
	@echo "$(GREEN)ğŸ”§ å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨...$(NC)"
	@npm run dev

install: ## å®‰è£…ä¾èµ–
	@echo "$(GREEN)ğŸ“¦ å®‰è£…ä¾èµ–...$(NC)"
	@npm install

##@ ç»„åˆå‘½ä»¤

all: clean-img build prod ## å®Œæ•´é‡å»ºå¹¶å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ

all-dev: clean-img build-dev dev ## å®Œæ•´é‡å»ºå¹¶å¯åŠ¨å¼€å‘ç¯å¢ƒ

refresh: restart logs ## é‡å¯å¹¶æŸ¥çœ‹æ—¥å¿—

up: build prod ## æ„å»ºå¹¶å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
