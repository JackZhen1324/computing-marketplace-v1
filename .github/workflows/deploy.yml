name: Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: computing-marketplace-frontend
  DEPLOY_PATH: /opt/computing-marketplace/computing-marketplace-v1
  # GitHub ä»“åº“ä¿¡æ¯ï¼ˆç”¨äºæœåŠ¡å™¨æ‹‰å–ä»£ç ï¼‰
  REPO_URL: https://github.com/yourusername/your-repo.git  # ä¿®æ”¹ä¸ºä½ çš„ä»“åº“åœ°å€

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 8222 }}
          timeout: 15m
          script_stop: true
          script: |
            # Set variables
            APP_PORT="${{ secrets.APP_PORT || 9210 }}"
            DEPLOY_DIR="/opt/computing-marketplace/computing-marketplace-v1/frontend"

            echo "ğŸš€ Starting deployment..."
            echo "Deploy directory: $DEPLOY_DIR"
            echo "App port: $APP_PORT"
            echo ""

            # Step 1: Change to frontend directory
            echo "ğŸ“ Step 1: Changing to frontend directory..."
            cd $DEPLOY_DIR || {
              echo "âŒ Failed to change to directory: $DEPLOY_DIR"
              exit 1
            }
            echo "âœ… Changed to: $(pwd)"
            echo ""

            # Step 2: Handle local changes and pull latest code
            echo "ğŸ“¥ Step 2: Handling local changes and pulling latest code..."

            # Stash any local modifications
            if [ -n "$(git status --porcelain)" ]; then
              echo "ğŸ“¦ Found local changes, stashing..."
              git stash push -m "Auto-stash before deployment $(date +%Y%m%d_%H%M%S)" || {
                echo "âš ï¸  Warning: Failed to stash changes, attempting reset..."
              }
            fi

            # Pull latest code with --force to handle conflicts
            git fetch origin main
            git reset --hard origin/main || {
              echo "âŒ Git reset failed"
              exit 1
            }
            echo "âœ… Code updated successfully"
            echo ""

            # Step 3: Rebuild and restart container
            echo "ğŸ³ Step 3: Rebuilding and restarting container..."
            docker-compose up -d --build || {
              echo "âŒ Docker compose failed"
              docker-compose logs
              exit 1
            }
            echo "âœ… Container restarted successfully"
            echo ""

            echo "========================================"
            echo "âœ… Deployment completed successfully!"
            echo "========================================"
            echo ""
            echo "ğŸŒ Application is running at: http://localhost:$APP_PORT"
            echo ""
            echo "ğŸ“Š Container status:"
            docker ps --filter "name=computing-marketplace"
            echo ""

