name: Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: computing-marketplace-frontend
  DEPLOY_PATH: /opt/computing-marketplace
  # GitHub ‰ªìÂ∫ì‰ø°ÊÅØÔºàÁî®‰∫éÊúçÂä°Âô®ÊãâÂèñ‰ª£Á†ÅÔºâ
  REPO_URL: https://github.com/yourusername/your-repo.git  # ‰øÆÊîπ‰∏∫‰Ω†ÁöÑ‰ªìÂ∫ìÂú∞ÂùÄ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 8222 }}
          timeout: 15m
          script_stop: true
          script: |
            # Set variables
            CONTAINER_NAME="computing-marketplace-frontend"
            DEPLOY_DIR="${{ secrets.DEPLOY_PATH || '/opt/computing-marketplace' }}"
            APP_PORT="${{ secrets.APP_PORT || 3000 }}"
            REPO_URL="${{ secrets.REPO_URL || 'https://github.com/yourusername/your-repo.git' }}"
            BRANCH="${{ secrets.BRANCH || 'main' }}"

            echo "üöÄ Starting deployment..."
            echo "Deploy directory: $DEPLOY_DIR"
            echo "Container name: $CONTAINER_NAME"
            echo "App port: $APP_PORT"
            echo "Repository: $REPO_URL"
            echo "Branch: $BRANCH"
            echo ""

            # Check current directory
            echo "üìç Current directory: $(pwd)"

            # Create deploy directory
            echo "üìÅ Creating deploy directory..."
            sudo mkdir -p $DEPLOY_DIR || {
              echo "‚ùå Failed to create deploy directory"
              exit 1
            }
            echo "‚úÖ Deploy directory created"

            cd $DEPLOY_DIR || {
              echo "‚ùå Failed to change to deploy directory"
              exit 1
            }
            echo "üìç Changed to: $(pwd)"
            echo ""

            # Check if git repository exists
            if [ -d ".git" ]; then
              echo "üì• Repository exists, pulling latest code..."
              git fetch origin || {
                echo "‚ùå Git fetch failed"
                exit 1
              }
              git reset --hard origin/$BRANCH || {
                echo "‚ùå Git reset failed"
                exit 1
              }
              git checkout $BRANCH || {
                echo "‚ùå Git checkout failed"
                exit 1
              }
            else
              echo "üì• Cloning repository..."
              echo "Cloning from: $REPO_URL branch: $BRANCH"
              git clone --depth 1 --branch $BRANCH $REPO_URL . || {
                echo "‚ùå Git clone failed"
                echo ""
                echo "Troubleshooting:"
                echo "1. Check REPO_URL: $REPO_URL"
                echo "2. Make sure repository is public or token is configured"
                echo "3. Test on server: git clone $REPO_URL /tmp/test"
                echo ""
                exit 1
              }
            fi

            echo "‚úÖ Code updated successfully"
            echo ""

            # List directory contents
            echo "üìÇ Repository contents:"
            ls -la
            echo ""

            # Check if frontend directory exists
            if [ ! -d "frontend" ]; then
              echo "‚ùå Error: frontend directory not found in repository"
              echo ""
              echo "Available directories:"
              ls -d */ 2>/dev/null || echo "No directories found"
              echo ""
              echo "Please check your repository structure"
              exit 1
            fi

            echo "‚úÖ Frontend directory found"
            echo ""

            # Backup current docker-compose.yml if exists
            if [ -f docker-compose.yml ]; then
              BACKUP_FILE="docker-compose.yml.backup-$(date +%Y%m%d-%H%M%S)"
              cp docker-compose.yml $BACKUP_FILE
              echo "‚úÖ Backed up docker-compose.yml to $BACKUP_FILE"
            fi

            # Create docker-compose.yml
            echo "üìù Creating docker-compose.yml..."
            cat > docker-compose.yml << 'EOF'
            version: '3.8'

            services:
              frontend:
                build:
                  context: ./frontend
                  dockerfile: Dockerfile
                container_name: computing-marketplace-frontend
                ports:
                  - "3000:8080"
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                networks:
                  - app-network
                healthcheck:
                  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

            networks:
              app-network:
                driver: bridge
            EOF

            echo "‚úÖ docker-compose.yml created"
            echo ""

            # Stop and remove old container
            echo "üõë Checking for old containers..."
            if docker ps -a | grep -q $CONTAINER_NAME; then
              echo "Stopping old container: $CONTAINER_NAME"
              docker stop $CONTAINER_NAME 2>/dev/null || true
              docker rm $CONTAINER_NAME 2>/dev/null || true
              echo "‚úÖ Old container removed"
            else
              echo "‚ÑπÔ∏è No old container found"
            fi
            echo ""

            # Remove old image to force rebuild
            echo "üßπ Cleaning up old images..."
            docker rmi ${DEPLOY_DIR}_frontend 2>/dev/null || true
            echo ""

            # Build and start new container
            echo "üî® Building Docker image..."
            echo "This may take 5-10 minutes on first run..."
            if docker-compose build --no-cache; then
              echo "‚úÖ Build completed"
            else
              echo "‚ùå Docker build failed"
              echo "Build logs:"
              docker-compose logs
              exit 1
            fi
            echo ""

            echo "üöÄ Starting container..."
            if docker-compose up -d; then
              echo "‚úÖ Container started"
            else
              echo "‚ùå Failed to start container"
              docker-compose logs
              exit 1
            fi
            echo ""

            # Wait for container to be healthy
            echo "‚è≥ Waiting for container to be ready..."
            MAX_WAIT=60
            WAIT_TIME=0
            while [ $WAIT_TIME -lt $MAX_WAIT ]; do
              if docker ps | grep -q $CONTAINER_NAME; then
                if curl -f -s "http://localhost:3000/" > /dev/null 2>&1; then
                  echo "‚úÖ Container is healthy and responding!"
                  break
                fi
              fi
              echo "   Waiting... ($WAIT_TIME/$MAX_WAIT seconds)"
              sleep 5
              WAIT_TIME=$((WAIT_TIME + 5))
            done

            if [ $WAIT_TIME -ge $MAX_WAIT ]; then
              echo "‚ö†Ô∏è  Health check timed out after ${MAX_WAIT}s"
              echo "Container logs:"
              docker logs --tail 50 $CONTAINER_NAME
            fi
            echo ""

            # Show container status
            echo "üìä Container status:"
            docker ps -f name=$CONTAINER_NAME
            echo ""

            # Show recent logs
            echo "üìã Recent container logs:"
            docker logs --tail 20 $CONTAINER_NAME
            echo ""

            # Clean up old images
            echo "üßπ Cleaning up old images (older than 72 hours)..."
            docker image prune -af --filter "until=72h" 2>/dev/null || true
            echo ""

            echo "========================================"
            echo "‚úÖ Deployment completed successfully!"
            echo "========================================"
            echo ""
            echo "üåê Application is running at: http://localhost:$APP_PORT"
            echo "üìä Container name: $CONTAINER_NAME"
            echo "üìÇ Deploy directory: $DEPLOY_DIR"
            echo ""
            echo "üìù Useful commands:"
            echo "  View logs: docker logs -f $CONTAINER_NAME"
            echo "  Stop: docker stop $CONTAINER_NAME"
            echo "  Restart: docker restart $CONTAINER_NAME"
            echo ""

