name: Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: computing-marketplace-frontend
  DEPLOY_PATH: /opt/computing-marketplace
  # GitHub ä»“åº“ä¿¡æ¯ï¼ˆç”¨äºæœåŠ¡å™¨æ‹‰å–ä»£ç ï¼‰
  REPO_URL: https://github.com/yourusername/your-repo.git  # ä¿®æ”¹ä¸ºä½ çš„ä»“åº“åœ°å€

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 8222 }}
          timeout: 15m
          script_stop: true
          script: |
            set -x  # å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œæ‰“å°æ¯ä¸ªå‘½ä»¤

            # Set variables
            CONTAINER_NAME="computing-marketplace-frontend"
            DEPLOY_DIR="${{ secrets.DEPLOY_PATH || '/opt/computing-marketplace' }}"
            APP_PORT="${{ secrets.APP_PORT || 3000 }}"
            REPO_URL="${{ secrets.REPO_URL || 'https://github.com/yourusername/your-repo.git' }}"
            BRANCH="${{ secrets.BRANCH || 'main' }}"

            echo "ğŸš€ Starting deployment..."
            echo "Deploy directory: $DEPLOY_DIR"
            echo "Container name: $CONTAINER_NAME"
            echo "App port: $APP_PORT"
            echo "Repository: $REPO_URL"
            echo "Branch: $BRANCH"

            # Check current directory
            echo "ğŸ“ Current directory: $(pwd)"

            # Create deploy directory
            echo "ğŸ“ Creating deploy directory..."
            sudo mkdir -p $DEPLOY_DIR || {
              echo "âŒ Failed to create deploy directory"
              exit 1
            }
            echo "âœ… Deploy directory created"

            cd $DEPLOY_DIR || {
              echo "âŒ Failed to change to deploy directory"
              exit 1
            }
            echo "ğŸ“ Changed to: $(pwd)"

            # Clone or pull repository
            if [ -d ".git" ]; then
              echo "ğŸ“¥ Pulling latest code from repository..."
              git fetch origin || {
                echo "âŒ Git fetch failed"
                exit 1
              }
              git reset --hard origin/$BRANCH || {
                echo "âŒ Git reset failed"
                exit 1
              }
              git checkout $BRANCH || {
                echo "âŒ Git checkout failed"
                exit 1
              }
            else
              echo "ğŸ“¥ Cloning repository..."
              echo "Cloning from: $REPO_URL"
              git clone --depth 1 --branch $BRANCH $REPO_URL . || {
                echo "âŒ Git clone failed"
                echo "Please check:"
                echo "1. REPO_URL is correct: $REPO_URL"
                echo "2. Repository is public or access token is configured"
                echo "3. Server can access GitHub"
                exit 1
              }
            fi

            echo "âœ… Code updated successfully"

            # List directory contents
            echo "ğŸ“‚ Directory contents:"
            ls -la

            # Check if frontend directory exists
            if [ ! -d "frontend" ]; then
              echo "âŒ Error: frontend directory not found in repository"
              echo "Available directories:"
            ls -d */
              exit 1
            fi

            # Backup current docker-compose.yml if exists
            if [ -f docker-compose.yml ]; then
              cp docker-compose.yml docker-compose.yml.backup-$(date +%Y%m%d-%H%M%S)
              echo "âœ… Backed up docker-compose.yml"
            fi

            # Create docker-compose.yml
            cat > docker-compose.yml << 'EOF'
            version: '3.8'

            services:
              frontend:
                build:
                  context: ./frontend
                  dockerfile: Dockerfile
                container_name: computing-marketplace-frontend
                ports:
                  - "3000:8080"
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                networks:
                  - app-network
                healthcheck:
                  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

            networks:
              app-network:
                driver: bridge
            EOF

            echo "âœ… docker-compose.yml created"

            # Stop and remove old container
            echo "ğŸ›‘ Stopping old container..."
            if docker ps -a | grep -q $CONTAINER_NAME; then
              docker stop $CONTAINER_NAME 2>/dev/null || true
              docker rm $CONTAINER_NAME 2>/dev/null || true
              echo "âœ… Old container stopped"
            else
              echo "â„¹ï¸ No old container found"
            fi

            # Remove old image to force rebuild
            echo "ğŸ§¹ Removing old image..."
            docker rmi ${DEPLOY_DIR}_frontend 2>/dev/null || true

            # Build and start new container
            echo "ğŸ”¨ Building new image..."
            docker-compose build --no-cache || {
              echo "âŒ Docker build failed"
              echo "Showing build logs:"
            docker-compose logs
              exit 1
            }

            echo "ğŸš€ Starting container..."
            docker-compose up -d || {
              echo "âŒ Failed to start container"
              docker-compose logs
              exit 1
            }

            # Wait for container to be healthy
            echo "â³ Waiting for container to be healthy..."
            MAX_WAIT=60
            WAIT_TIME=0
            while [ $WAIT_TIME -lt $MAX_WAIT ]; do
              if docker ps | grep -q $CONTAINER_NAME; then
                if curl -f -s "http://localhost:3000/" > /dev/null 2>&1; then
                  echo "âœ… Container is healthy and responding!"
                  break
                fi
              fi
              echo "   Waiting... ($WAIT_TIME/$MAX_WAIT seconds)"
              sleep 5
              WAIT_TIME=$((WAIT_TIME + 5))
            done

            if [ $WAIT_TIME -ge $MAX_WAIT ]; then
              echo "âš ï¸  Health check timed out"
              echo "Container logs:"
              docker logs $CONTAINER_NAME
            fi

            # Show container status
            echo ""
            echo "ğŸ“Š Container status:"
            docker ps -f name=$CONTAINER_NAME

            # Clean up old images
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=72h" 2>/dev/null || true

            echo ""
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application is running at: http://localhost:$APP_PORT"

