// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== User Management ==============

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  passwordHash   String    @map("password_hash")
  role           UserRole  @default(CUSTOMER)
  fullName       String?   @map("full_name")
  phone          String?
  companyName    String?   @map("company_name")
  isActive       Boolean   @default(true) @map("is_active")
  emailVerified  Boolean   @default(false) @map("email_verified")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  createdInquiries  Inquiry[] @relation("CreatedBy")
  assignedInquiries Inquiry[] @relation("AssignedTo")
  createdOrders     Order[]   @relation("OrderCreatedBy")
  updatedOrders     Order[]   @relation("OrderUpdatedBy")
  orders            Order[]   @relation("CustomerOrders")
  activityLogs      ActivityLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  SALES
  CUSTOMER
}

// ============== Categories ==============

model Category {
  id          String   @id
  name        String
  nameEn      String?  @map("name_en")
  description String?
  iconUrl     String?  @map("icon_url")
  displayOrder Int     @default(0) @map("display_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  products Product[]

  @@map("categories")
}

// ============== Products ==============

model Product {
  id             String   @id
  categoryId     String   @map("category_id")
  name           String
  title          String?
  subtitle       String?
  description    String?
  imageUrl       String?  @map("image_url")
  priceDisplay   String?  @map("price_display")
  source         String?
  region         String?
  tags           String[]
  cpuMemoryRatio String?  @map("cpu_memory_ratio")
  vcpuRange      String?  @map("vcpu_range")
  baseFreq       String?  @map("base_freq")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  category       Category              @relation(fields: [categoryId], references: [id])
  features       ProductFeature[]
  specifications ProductSpecification[]
  pricing        ProductPricing[]
  useCases       ProductUseCase[]
  inquiries      Inquiry[]
  orders         Order[]
  orderItems     OrderItem[]

  @@index([categoryId])
  @@index([tags])
  @@map("products")
}

model ProductFeature {
  productId    String @map("product_id")
  featureText  String @map("feature_text")
  displayOrder Int    @default(0) @map("display_order")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, displayOrder])
  @@map("product_features")
}

model ProductSpecification {
  productId    String @map("product_id")
  specLabel    String @map("spec_label")
  specValue    String @map("spec_value")
  displayOrder Int    @default(0) @map("display_order")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, displayOrder])
  @@map("product_specifications")
}

model ProductPricing {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  planName     String   @map("plan_name")
  price        String
  features     Json
  displayOrder Int      @default(0) @map("display_order")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_pricing")
}

model ProductUseCase {
  productId    String @map("product_id")
  useCase      String @map("use_case")
  displayOrder Int    @default(0) @map("display_order")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, displayOrder])
  @@map("product_use_cases")
}

// ============== Solutions ==============

model Solution {
  id          String   @id
  title       String
  subtitle    String?
  description String?
  highlights  String[]
  architecture String?
  imageUrl    String?  @map("image_url")
  features    Json
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  benefits SolutionBenefit[]

  @@map("solutions")
}

model SolutionBenefit {
  solutionId         String  @map("solution_id")
  benefitTitle       String  @map("benefit_title")
  benefitDescription String? @map("benefit_description")
  iconUrl            String? @map("icon_url")
  displayOrder       Int     @default(0) @map("display_order")

  // Relations
  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@id([solutionId, displayOrder])
  @@map("solution_benefits")
}

// ============== Inquiries ==============

model Inquiry {
  id               String       @id @default(uuid())
  productId        String?      @map("product_id")
  productName      String?      @map("product_name")
  productCategory  String?      @map("product_category")
  customerName     String       @map("customer_name")
  contactPhone     String       @map("contact_phone")
  email            String?
  companyName      String?      @map("company_name")
  interestedProducts String[]   @map("interested_products")
  specification    String?
  requirements     Json?        // Store product-specific form fields as JSON
  status           InquiryStatus @default(PENDING)
  priority         Priority     @default(MEDIUM)
  notes            String?
  createdById      String?      @map("created_by_id")
  assigneeId       String?      @map("assignee_id")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  product    Product? @relation(fields: [productId], references: [id])
  createdBy  User?    @relation("CreatedBy", fields: [createdById], references: [id])
  assignedTo User?    @relation("AssignedTo", fields: [assigneeId], references: [id])
  orders     Order[]

  @@index([status])
  @@index([customerName])
  @@map("inquiries")
}

enum InquiryStatus {
  PENDING
  CONTACTED
  NEGOTIATING
  CLOSED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

// ============== Orders ==============

model Order {
  id                String      @id @default(uuid())
  orderNumber       String      @unique @map("order_number")
  customerId        String?     @map("customer_id")
  inquiryId         String?     @map("inquiry_id")
  productId         String?     @map("product_id")
  productName       String      @map("product_name")
  quantity          Int         @default(1)
  unitPrice         Decimal?    @map("unit_price") @db.Decimal(15, 2)
  totalPrice        Decimal?    @map("total_price") @db.Decimal(15, 2)
  currency          String      @default("CNY")
  status            OrderStatus @default(PENDING)
  billingCycle      String?     @map("billing_cycle")
  contractStartDate DateTime?   @map("contract_start_date")
  contractEndDate   DateTime?   @map("contract_end_date")
  notes             String?
  createdById       String?     @map("created_by_id")
  updatedById       String?     @map("updated_by_id")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  customer   User?        @relation("CustomerOrders", fields: [customerId], references: [id])
  inquiry    Inquiry?     @relation(fields: [inquiryId], references: [id])
  product    Product?     @relation(fields: [productId], references: [id])
  orderItems OrderItem[]
  createdUser User?        @relation("OrderCreatedBy", fields: [createdById], references: [id])
  updatedUser User?        @relation("OrderUpdatedBy", fields: [updatedById], references: [id])

  @@index([customerId])
  @@index([status])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model OrderItem {
  id           String    @id @default(uuid())
  orderId      String    @map("order_id")
  productId    String?   @map("product_id")
  productName  String?   @map("product_name")
  quantity     Int
  unitPrice    Decimal?  @map("unit_price") @db.Decimal(15, 2)
  totalPrice   Decimal?  @map("total_price") @db.Decimal(15, 2)
  specifications Json?
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// ============== News/Policy ==============

model NewsArticle {
  id           String   @id @default(uuid())
  type         NewsType
  title        String
  summary      String?
  content      String?
  source       String?
  publishDate  DateTime @map("publish_date")
  tag          String?
  imageUrl     String?  @map("image_url")
  isPublished  Boolean  @default(true) @map("is_published")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([type])
  @@index([isPublished])
  @@map("news_articles")
}

enum NewsType {
  POLICY
  NEWS
}

// ============== Navigation ==============

model NavigationItem {
  id           String   @id
  label        String
  path         String?
  parentId     String?  @map("parent_id")
  icon         String?
  displayOrder Int      @default(0) @map("display_order")
  isVisible    Boolean  @default(true) @map("is_visible")
  requiresAuth Boolean  @default(false) @map("requires_auth")
  allowedRoles String[] @map("allowed_roles")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  parent   NavigationItem?  @relation("NavigationHierarchy", fields: [parentId], references: [id])
  children NavigationItem[] @relation("NavigationHierarchy")

  @@map("navigation_items")
}

// ============== Activity Logs ==============

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  changes    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@map("activity_logs")
}
